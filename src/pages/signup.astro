---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="AlphaMail â€” Get Started">
  <div class="w-full">
    <div class="w-full max-w-2xl mx-auto px-6 sm:px-8 py-12">
      <!-- Header -->
      <div id="page-header" class="text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-['Song_Myung'] tracking-tight mb-3">
          let's get started
        </h1>
        <p class="text-lg text-neutral-600">
          enter your email and alpha will reach out.
        </p>
      </div>

      <!-- Compose Email -->
      <form id="compose-form" novalidate class="relative rounded-xl bg-white/80 backdrop-blur-xl shadow-2xl border border-white/20 ring-1 ring-black/5 overflow-hidden flex flex-col w-full text-left mb-10">
        <!-- Window Chrome / Toolbar -->
        <div class="h-12 bg-gradient-to-b from-[#f6f6f6] to-[#e8e8e8] border-b border-[#d1d1d1] flex items-center justify-between px-4 shadow-[0_1px_0_rgba(255,255,255,0.5)_inset]">
          <div class="flex gap-2">
            <div class="w-3 h-3 rounded-full bg-[#FF5F57] border border-[#E09E3E]/30 shadow-sm"></div>
            <div class="w-3 h-3 rounded-full bg-[#FEBC2E] border border-[#DFA023]/30 shadow-sm"></div>
            <div class="w-3 h-3 rounded-full bg-[#28C840] border border-[#1AAB29]/30 shadow-sm"></div>
          </div>
          <button
            type="submit"
            id="send-btn"
            formnovalidate
            class="w-20 h-8 inline-flex items-center justify-center gap-1.5 rounded-md font-mono text-xs font-medium text-white bg-gradient-to-t from-blue-600 to-blue-500 shadow-sm hover:shadow-md hover:scale-[102%] active:scale-[98%] transition-all cursor-pointer"
          >
            <span id="send-text">Send</span>
            <svg id="send-spinner" class="hidden animate-spin h-3.5 w-3.5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <kbd id="send-kbd" class="hidden sm:inline-flex items-center gap-0.5 text-[10px] text-blue-200 font-normal"><span class="kbd-mod"></span><span>&#9166;</span></kbd>
          </button>
        </div>

        <!-- Compose Fields -->
        <div class="flex flex-col bg-white">
          <div class="flex items-center px-4 py-2 border-b border-[#e5e5e5]">
            <span class="text-neutral-400 w-16 text-left mr-3 text-sm font-medium">To:</span>
            <span class="text-neutral-900 text-sm">alpha &lt;alpha@bealphamail.com&gt;</span>
          </div>
          <div class="flex items-center px-4 py-2 border-b border-[#e5e5e5]">
            <span class="text-neutral-400 w-16 text-left mr-3 text-sm font-medium">From:</span>
            <input
              type="email"
              id="email-input"
              name="email"
              required
              placeholder="you@example.com"
              autofocus
              class="flex-1 text-sm text-neutral-900 bg-transparent outline-none placeholder:text-neutral-300"
            />
          </div>
          <div class="flex items-center px-4 py-2 border-b border-[#e5e5e5]">
            <span class="text-neutral-400 w-16 text-left mr-3 text-sm font-medium">Subject:</span>
            <span class="text-neutral-900 text-sm font-medium">let's be friends</span>
          </div>
        </div>

        <!-- Fixed Email Body -->
        <div class="px-4 py-3 bg-white text-sm leading-relaxed text-neutral-500">
          <p>hey alpha, i'd like to get started.</p>
        </div>

        <!-- Error (absolute so no layout shift) -->
        <div id="form-error" class="hidden absolute bottom-0 left-0 right-0 px-5 py-3 bg-red-50 text-red-600 text-sm border-t border-red-100"></div>
      </form>

      <!-- Success (hidden until signup completes) -->
      <div id="success-state" class="hidden text-center">
        <h1 class="text-4xl sm:text-5xl font-['Song_Myung'] tracking-tight mb-3">check your email.</h1>
        <p class="text-lg text-neutral-600 mb-6">
          alpha sent you a confirmation link -- click it to prove you're real, then we'll get going.
        </p>
        <p class="text-neutral-400 text-sm">
          didn't get it? check your spam folder or <button id="resend-link" class="text-blue-600 underline cursor-pointer">resend</button>
        </p>
      </div>

      <p id="early-access" class="text-neutral-500 text-center">free during early access</p>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from "../lib/supabase";

  const composeForm = document.getElementById("compose-form") as HTMLFormElement;
  const sendBtn = document.getElementById("send-btn") as HTMLButtonElement;
  const sendText = document.getElementById("send-text") as HTMLSpanElement;
  const sendSpinner = document.getElementById("send-spinner") as SVGElement;
  const sendKbd = document.getElementById("send-kbd") as HTMLElement;
  const emailInput = document.getElementById("email-input") as HTMLInputElement;
  const formError = document.getElementById("form-error") as HTMLDivElement;
  const successState = document.getElementById("success-state") as HTMLDivElement;

  // Pre-fill email from query param (e.g., from inbound redirect)
  const params = new URLSearchParams(window.location.search);
  const prefillEmail = params.get("email");
  if (prefillEmail) emailInput.value = prefillEmail;

  function setLoading(loading: boolean) {
    sendBtn.disabled = loading;
    sendText.classList.toggle("hidden", loading);
    sendSpinner.classList.toggle("hidden", !loading);
    sendKbd.classList.toggle("sm:inline-flex", !loading);
    sendKbd.classList.toggle("hidden", loading);
  }

  // Show platform-appropriate modifier key
  const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
  const kbdMod = document.querySelector(".kbd-mod");
  if (kbdMod) kbdMod.textContent = isMac ? "\u2318" : "Ctrl";

  // Prevent bare Enter in email field from submitting
  emailInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.metaKey && !e.ctrlKey) {
      e.preventDefault();
    }
  });

  // Cmd/Ctrl + Enter to submit
  document.addEventListener("keydown", (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
      e.preventDefault();
      composeForm.requestSubmit();
    }
  });

  let lastEmail = "";

  async function sendConfirmation(email: string) {
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: `${window.location.origin}/welcome`,
      },
    });

    if (error) {
      throw new Error(error.message);
    }
  }

  composeForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    formError.classList.add("hidden");
    setLoading(true);

    const email = emailInput.value.trim();

    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      formError.textContent = "please enter a valid email";
      formError.classList.remove("hidden");
      setLoading(false);
      return;
    }

    try {
      lastEmail = email;
      await sendConfirmation(email);

      // Show success
      const pageHeader = document.getElementById("page-header");
      const earlyAccess = document.getElementById("early-access");
      if (pageHeader) pageHeader.classList.add("hidden");
      if (earlyAccess) earlyAccess.classList.add("hidden");
      composeForm.classList.add("hidden");
      successState.classList.remove("hidden");
    } catch (err: any) {
      formError.textContent = err.message || "something went wrong";
      formError.classList.remove("hidden");
      setLoading(false);
    }
  });

  // Resend link
  const resendLink = document.getElementById("resend-link");
  if (resendLink) {
    resendLink.addEventListener("click", async () => {
      if (!lastEmail) return;
      resendLink.textContent = "sending...";
      try {
        await sendConfirmation(lastEmail);
        resendLink.textContent = "sent!";
        setTimeout(() => { resendLink.textContent = "resend"; }, 3000);
      } catch {
        resendLink.textContent = "failed -- try again";
        setTimeout(() => { resendLink.textContent = "resend"; }, 3000);
      }
    });
  }
</script>
