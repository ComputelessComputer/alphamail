---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="AlphaMail â€” Welcome">
  <div class="w-full">
    <div class="w-full max-w-md mx-auto px-6 sm:px-8 py-12">
      <div id="loading" class="text-center">
        <h1 class="text-3xl font-['Song_Myung'] tracking-tight mb-4">one sec...</h1>
      </div>

      <div id="welcome" class="hidden text-center">
        <h1 class="text-4xl sm:text-5xl font-['Song_Myung'] tracking-tight mb-3">welcome.</h1>
        <p class="text-lg text-neutral-600 mb-6">
          alpha just sent you an email -- reply to it with your name and a goal to get started.
        </p>
        <p class="text-neutral-400 text-sm">
          didn't get it? check your spam folder or <a href="/signup" class="text-blue-600 underline">try again</a>
        </p>
      </div>

      <div id="error-state" class="hidden text-center">
        <h1 class="text-3xl font-['Song_Myung'] tracking-tight mb-4">something went wrong</h1>
        <p class="text-neutral-600">
          <a href="/signup" class="text-blue-600 underline">try signing up again</a>
        </p>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from "../lib/supabase";

  const loadingDiv = document.getElementById("loading") as HTMLDivElement;
  const welcomeDiv = document.getElementById("welcome") as HTMLDivElement;
  const errorDiv = document.getElementById("error-state") as HTMLDivElement;

  function showWelcome() {
    loadingDiv.classList.add("hidden");
    welcomeDiv.classList.remove("hidden");
  }

  function showError() {
    loadingDiv.classList.add("hidden");
    errorDiv.classList.remove("hidden");
  }

  async function sendOnboardingEmail(token: string) {
    try {
      console.log("Sending onboarding email, token length:", token?.length);
      const res = await fetch("/api/email/onboarding", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token }),
      });
      const data = await res.json();
      console.log("Onboarding email response:", res.status, data);
      if (!res.ok) {
        console.error("Onboarding email failed:", data);
      }
    } catch (err) {
      console.error("Failed to send onboarding email:", err);
    }
  }

  let handled = false;

  async function handleSession(session: any) {
    if (handled || !session) return;
    handled = true;

    // Check if already onboarded
    const { data: profile } = await supabase
      .from("profiles")
      .select("onboarded")
      .eq("user_id", session.user.id)
      .single();

    if (profile?.onboarded) {
      window.location.href = "/account";
      return;
    }

    // Show welcome immediately, send onboarding email in background
    showWelcome();
    sendOnboardingEmail(session.access_token);
  }

  // Listen for auth state changes (handles both hash fragment and PKCE flows)
  supabase.auth.onAuthStateChange((event, session) => {
    console.log("Auth state change:", event, !!session);
    if (session) handleSession(session);
  });

  // Also try existing session as fallback
  async function init() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    // PKCE flow: exchange code for session
    if (code) {
      const { data, error } = await supabase.auth.exchangeCodeForSession(code);
      if (error || !data.session) {
        console.error("Code exchange failed:", error?.message);
        showError();
        return;
      }
      handleSession(data.session);
      return;
    }

    // Give onAuthStateChange a moment to process hash tokens
    setTimeout(async () => {
      if (handled) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        handleSession(session);
      } else {
        showError();
      }
    }, 1500);
  }

  init();
</script>
