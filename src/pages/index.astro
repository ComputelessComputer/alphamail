---
import BaseLayout from "../layouts/BaseLayout.astro";

const ctaNote = "Free during early access";
---

<BaseLayout
  title="AlphaMail — Weekly goal check-ins by email"
  description="AlphaMail is an AI-powered goal tracking system that keeps you accountable with weekly email check-ins."
>
  <div class="w-full">
    <div class="w-full max-w-2xl mx-auto px-6 sm:px-8 py-12">
      <!-- Headline -->
      <div class="text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-['Song_Myung'] tracking-tight mb-3">
          AlphaMail
        </h1>
        <p class="text-lg text-neutral-600">
          Weekly goals. Sunday check-ins. Zero apps.
        </p>
      </div>

      <!-- Email Compose View -->
      <form id="signup-form" class="rounded-xl bg-white/80 backdrop-blur-xl shadow-2xl border border-white/20 ring-1 ring-black/5 overflow-hidden flex flex-col w-full text-left mb-10">
        <!-- Window Chrome / Toolbar -->
        <div class="h-12 bg-gradient-to-b from-[#f6f6f6] to-[#e8e8e8] border-b border-[#d1d1d1] flex items-center justify-between px-4 shadow-[0_1px_0_rgba(255,255,255,0.5)_inset]">
          <div class="flex gap-2">
            <div class="w-3 h-3 rounded-full bg-[#FF5F57] border border-[#E09E3E]/30 shadow-sm"></div>
            <div class="w-3 h-3 rounded-full bg-[#FEBC2E] border border-[#DFA023]/30 shadow-sm"></div>
            <div class="w-3 h-3 rounded-full bg-[#28C840] border border-[#1AAB29]/30 shadow-sm"></div>
          </div>
          <button
            type="submit"
            id="send-btn"
            class="px-4 h-7 inline-flex items-center rounded-md text-xs font-medium text-white bg-gradient-to-t from-blue-600 to-blue-500 shadow-sm hover:shadow-md hover:scale-[102%] active:scale-[98%] transition-all cursor-pointer"
          >
            <span id="send-text">Send ↑</span>
          </button>
        </div>

        <!-- Email Compose Fields -->
        <div class="flex flex-col bg-white">
          <div class="flex items-center px-4 py-2 border-b border-[#e5e5e5]">
            <span class="text-neutral-400 w-16 text-left mr-3 text-sm font-medium">To:</span>
            <span class="text-neutral-900 text-sm">Alpha &lt;alpha@bealphamail.com&gt;</span>
          </div>
          <div class="flex items-center px-4 py-2 border-b border-[#e5e5e5]">
            <span class="text-neutral-400 w-16 text-left mr-3 text-sm font-medium">From:</span>
            <input
              type="email"
              id="email-input"
              name="email"
              required
              placeholder="you@example.com"
              class="flex-1 text-sm text-neutral-900 bg-transparent outline-none placeholder:text-neutral-300"
            />
          </div>
          <div class="flex items-center px-4 py-2 border-b border-[#e5e5e5]">
            <span class="text-neutral-400 w-16 text-left mr-3 text-sm font-medium">Subject:</span>
            <span class="text-neutral-900 text-sm font-medium">let's be friends</span>
          </div>
        </div>

        <!-- Email Body (preview of what Alpha will say) -->
        <div class="p-5 sm:p-6 bg-neutral-50/50 text-neutral-400 text-sm leading-relaxed space-y-3 italic">
          <p>alpha will reply with your first steps —</p>
          <p>just enter your email and hit send.</p>
        </div>

        <!-- Error/Success messages -->
        <div id="form-error" class="hidden px-5 py-3 bg-red-50 text-red-600 text-sm"></div>
      </form>

      <!-- Success state (replaces form) -->
      <div id="success-state" class="hidden rounded-xl bg-white/80 backdrop-blur-xl shadow-2xl border border-white/20 ring-1 ring-black/5 overflow-hidden w-full text-center p-10 mb-10">
        <div class="text-4xl mb-4">✉️</div>
        <h2 class="text-xl font-medium text-neutral-900 mb-2">check your email!</h2>
        <p class="text-neutral-600" id="success-email-text">
          alpha just sent you an email. reply to it with your name and a goal to get started.
        </p>
      </div>

      <!-- CTA Note -->
      <p id="cta-note" class="text-neutral-500 text-center">{ctaNote}</p>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from "../lib/supabase";

  const form = document.getElementById("signup-form") as HTMLFormElement;
  const emailInput = document.getElementById("email-input") as HTMLInputElement;
  const sendBtn = document.getElementById("send-btn") as HTMLButtonElement;
  const sendText = document.getElementById("send-text") as HTMLSpanElement;
  const formError = document.getElementById("form-error") as HTMLDivElement;
  const successState = document.getElementById("success-state") as HTMLDivElement;
  const ctaNote = document.getElementById("cta-note") as HTMLParagraphElement;

  // Check if user is already logged in
  async function checkExistingUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      const { data: profile } = await supabase
        .from("profiles")
        .select("onboarded")
        .eq("user_id", user.id)
        .single();

      if (profile?.onboarded) {
        // Replace form with "welcome back" state
        sendText.textContent = "Go to account";
        sendBtn.type = "button";
        sendBtn.addEventListener("click", () => {
          window.location.href = "/account";
        });
        emailInput.value = user.email || "";
        emailInput.disabled = true;
        ctaNote.textContent = "Welcome back!";
      }
    }
  }
  checkExistingUser();

  // Handle form submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    formError.classList.add("hidden");
    sendBtn.disabled = true;
    sendText.textContent = "Sending...";

    const email = emailInput.value.trim();

    try {
      // Create user in Supabase
      const { data, error } = await supabase.auth.signUp({
        email,
        password: crypto.randomUUID(),
      });

      if (error && !error.message.includes("already registered")) {
        throw error;
      }

      // Send onboarding email from Alpha
      const res = await fetch("/api/email/onboarding", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, userId: data?.user?.id || null }),
      });

      if (!res.ok) throw new Error("Failed to send email");

      // Show success
      form.classList.add("hidden");
      successState.classList.remove("hidden");
      ctaNote.textContent = "";
    } catch (err: any) {
      formError.textContent = err.message || "Something went wrong";
      formError.classList.remove("hidden");
      sendBtn.disabled = false;
      sendText.textContent = "Send \u2191";
    }
  });
</script>
